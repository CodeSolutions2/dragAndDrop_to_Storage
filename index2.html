<!DOCTYPE html>
<html>
<head></head>
<body>


<input id="location_name" type="text" value="" placeholder="location_name" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">

<button id="try_to_fix_cors_error0" onclick="try_to_fix_cors_error0()">try_to_fix_cors_error0</button>
<button id="try_to_fix_cors_error_w_fetch" onclick="try_to_fix_cors_error_w_fetch()">try_to_fix_cors_error_w_fetch</button>
<button id="try_to_fix_cors_error_w_fetch1" onclick="try_to_fix_cors_error_w_fetch1()">try_to_fix_cors_error_w_fetch1</button>

<button id="get_lat_long" onclick="get_lat_long()">get_lat_long</button>
<button id="get_forecast_temperature_data" onclick="get_forecast_temperature_data()">get_forecast_temperature_data</button>





<!-- blog idea: https://www.jsdelivr.com/package/npm/express -->
<!-- <script src="https://cdn.jsdelivr.net/npm/express@4.19.2/index.min.js"></script> -->
<!-- OR -->
<!-- <script type="module"> -->
<!-- import { express } from "https://cdn.jsdelivr.net/npm/express@4.19.2/index.min.js"; -->
<!-- module.express = express; -->
<!-- </script> -->



<!-- blog idea: https://www.jsdelivr.com/package/npm/request -->
<!-- <script src="https://cdn.jsdelivr.net/npm/request@2.88.2/index.min.js"></script> -->
<!-- OR -->
<!-- <script type="module"> -->
<!-- import { request } from "https://cdn.jsdelivr.net/npm/request@2.88.2/index.min.js"; -->
<!-- module1.request = request; -->
<!-- </script> -->


	
<script>
	
// -----------------------------------------------
	
window.addEventListener('beforeunload', function() {
    window.location.href = window.location.href + '?nocache=' + new Date().getTime();
});

// -----------------------------------------------

// This mimics what a fetch function would return after it contacted a server with an endpoint 
function fakefetch_function(url, options) {
	
  // The server should return arguments like 
  return {
	  Accept: "image/avif,image/webp,*/*",
		Accept_Encoding: "gzip, deflate, br",
		Accept_Language: "en-US,en;q=0.5",
		Connection: "keep-alive",
		DNT: 1,
		Host: "codesolutions2.github.io",
		Referer: "https://codesolutions2.github.io/temp_repo_js_tests/index2.html",
		Sec_Fetch_Dest: "image",
		Sec_Fetch_Mode: options.mode,
		Sec_Fetch_Site: "same-origin",
		Sec_GPC: 1,
		User_Agent: "Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0",
    		headers: {server_assigned_val: 'something'}
	};
}
  
async function try_to_fix_cors_error0() {
  
	const handler2 = {
		apply: function(target, thisArg, args) {
			const [url, options] = args;
			if (options && options.headers) {
				options.headers['Access-Control-Allow-Origin'] = '*';
			} else {
				args[1] = { headers: { 'Access-Control-Allow-Origin': '*' } };
			}
			console.log('url: ', url);
			console.log('options: ', options);
			
			return Reflect.apply(target, thisArg, args);
		}
	};

	const handler3 = {
		get(target, prop, receiver) {
			console.log('prop: ', prop);
			console.log('prop has key options: ', prop === "options");
	    if (prop === "options") {
		    var options_existing = Object.entries(prop.options);
		    options_existing.headers['Access-Control-Allow-Origin'] = '*';
	      return options_existing;
	    }
	    return Reflect.get(...arguments);
	  },
	};
	
	var url = `https://nominatim.openstreetmap.org/search?q=${document.getElementById('location_name').innerHTML}`;
	var headers = {"Content-Type": "application/json"};
	var options = {method : 'GET', headers: headers,  mode: 'cors'};
	
	const proxy3 = new Proxy(fakefetch_function(url, options), handler3);
	
	console.log("proxy3: ", proxy3);

}

// -----------------------------------------------

async function try_to_fix_cors_error_w_fetch() {

	// Define a handler that contains a "Proxy trap" such that specific items in the target are only modified, and not all the items in the target 

	// This modifies the inputs of the fetch function, so it means that you are changing the client request variables. NOT the server response variables.
	
	const handler2 = {
		apply: function(target, thisArg, args) {
			const [url, options] = args;

			// this is what I put in - so I try to modify the client input....
			// need to figure out how to modify the 
			console.log('options BEFORE: ', options);
			
			if (options && options.headers) {
				options.headers['Access-Control-Allow-Origin'] = '*';
			} else {
				args[1] = { headers: { 'Access-Control-Allow-Origin': '*' } };
			}
			
			// The Reflect.apply method in JavaScript is used to call a target function with a specified this value and arguments. It allows you to invoke a function with a specific context and set of arguments.
			// So it calls fetch with the modified client payload
			return Reflect.apply(target, thisArg, args);
		}
	};

	
	
	var url = `https://nominatim.openstreetmap.org/search?q=${document.getElementById('location_name').innerHTML}`;
	var headers = {"Content-Type": "application/json"};
	var options = {method : 'GET', headers: headers,  mode: 'cors'};

	
	await fetch(url, options)
		.then(res => {
			// Need to do proxy on the server output in the promise maybe
			const handler3 = {
				get(target, prop, receiver) {
					if (prop === "options") {
						var options_existing = Object.entries(prop.options);
						options_existing.headers['Access-Control-Allow-Origin'] = '*';
						return options_existing;
					}
					return Reflect.get(...arguments);
				},
			};
			return new Proxy(res.json(), handler3);
		})
		.then(res => { 
				//let output = JSON.parse(JSON.stringify(res));
				console.log('res: ', res);
			})
			.catch(error => { console.log('error: ', error); });
	

}
  
// -----------------------------------------------

async function try_to_fix_cors_error_w_fetch1() {

	const fetchProxy = new Proxy(fetch, {
  apply: function(target, thisArg, args) {
    const [url, options] = args;
    if (options && options.headers) {
      options.headers['Access-Control-Allow-Origin'] = '*';
    } else {
      args[1] = { headers: { 'Access-Control-Allow-Origin': '*' } };
    }
    return Reflect.apply(target, thisArg, args);
  }
});

var url = `https://nominatim.openstreetmap.org/search?q=${document.getElementById('location_name').innerHTML}`;
await fetchProxy(url)
  .then(response => response.json())
  .then(data => console.log('data: ', data))
  .catch(error => console.error(error));

}

// -----------------------------------------------

// async function try_to_fix_cors_error1() {
	
	// blog idea: add the header to the request manually with a proxy server around http://domainname.com
// 	const module = {};
// 	const app = module.express();
// 	
// 	app.use((req, res, next) => {
// 		res.header('Access-Control-Allow-Origin', '*');
// 		next();
// 	});
// 
// 	const module1 = {};
// 	app.get(`/search?q=${document.getElementById('location_name').innerHTML}`, function (req, res) {
// 		var out = module1.request({url: 'https://nominatim.openstreetmap.org'}, (error, response, body) => {
// 			if (error || response.statusCode != 200) {
// 				console.log('error', error);
// 				return error;
// 			} else {
// 				console.log('body', body);
// 				return body;
// 			}
// 		});
// 		// res.json(JSON.parse(out));
// 	});
// 	
// 	app.listen(3000, () => { console.log('listing on port 3000'); });
// 
// }
  
// -----------------------------------------------
	
async function get_lat_long() {

	// https://maps.googleapis.com/maps/api/geocode/json?address=${address}&key=${GCP_API_KEY}
	// OR

	// https://nominatim.org/release-docs/latest/api/Search/
	var url = `https://nominatim.openstreetmap.org/search?q=${document.getElementById('location_name').innerHTML}`;
	var headers = {"Content-Type": "application/json"}
	var options = {method : 'GET', headers: headers,  mode: 'cors'};
		
		// ------------------------------------------

	
		
		await fetch(url, options)
			.then(res => res.json())
			.then(res => { 
				//let output = JSON.parse(JSON.stringify(res));
				console.log('res: ', res);
			})
			.catch(error => { document.getElementById('error').innerHTML = error; });

}
  
// -----------------------------------------------

async function get_forecast_temperature_data() {

	// https://nominatim.openstreetmap.org/search?q=Lyon&format=json
	var location_latitude = "45.7578137";
	var location_longitude = "4.8320114";

	
    // https://open-meteo.com/en/docs

  var url = 'https://open-meteo.com/v1/forecast';
	  
		var headers = {"Content-Type": "application/json"}
	
		var data = {"latitude": Number(location_latitude),
			    "longitude": Number(location_longitude), 
			    "forecast_days": 1, 
			    "forecast_hours": 5
		};
		
		// --------------------
		
		var options = {method : 'POST', headers: headers, body : JSON.stringify(data)};
		
		// ------------------------------------------
		
		await fetch(url, options)
			.then(res => res.json())
			.then(res => { 
				let output = JSON.parse(JSON.stringify(res));
				console.log('output: ', output);
			})
			.catch(error => { document.getElementById('error').innerHTML = error; });

  
  
}

// -----------------------------------------------




</script>

  
</body>
</html>
