<!DOCTYPE html>
<html>
<head></head>
<body>

<h3>A. Select the Storage Method and input authentication.</h3>
<input id="GCP_bucket_name" type="text" value="" placeholder="GCP bucket name" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<br>
<input id="GCP_SA_KEY" type="text" value="" placeholder="Input Google Cloud Service Account Key to authenticate" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<br>
 
<h3>B. Drag and drop files into the dropArea to Submit it to Google Cloud Storage.</h3>
<input type="file" id="upload_file" accept="audio/*" style="display:block" class="dropArea" multiple>
<br>
 
<h3>C. Submit files to Google Cloud Storage.</h3>
<button id="Submit_to_cloudStorage" onclick="Submit_to_cloudStorage()">Submit to cloudStorage</button>
<br>

<h3>D. List files from Storage.</h3>
<button id="List_bucket_contents" onclick="List_bucket_contents()">List bucket contents</button>

<div id="notification"></div>
<div id="error"></div>

<!-- ---------------------------------------- -->
<!-- CSS -->
<style>
div { padding: 10px; display:block; font-family:courier; font-size:15px; height:300px; }
div#notification { position: relative; color: #3236a8; }
div#error { position: relative; color: #bd1f17; }

.dropArea { height: 200px; width: 200px;	border-radius: 15px;	border: 0.25px solid black; }
</style>
<!-- ---------------------------------------- -->

<script type="module" crossorigin="*" redirect="follow" mode="cors">
import { run_backend_process } from "https://cdn.jsdelivr.net/npm/library_to_run_github_actions@1.0.1/dist/library_to_run_GitHub_Actions.js";
module.run_backend_process = run_backend_process;
</script>

<!-- --------------------------------------------------- -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
<script>

const module = {};

// ----------------------------------------------------
// Input functionality - FileReader type="file"
// ----------------------------------------------------
document.getElementById("upload_file").addEventListener("change", previewInput, false);

var obj = {};
 
async function previewInput(event) {

 // For multiple files
 const allFiles = event.target.files;
 // console.log("allFiles :", allFiles);
 
 var i = 0;
 while (i < allFiles.length) {
  
  const file = allFiles[i];
  // console.log("file :", file);

  await obtain_fileInfo_way1(file)
   .then(async (base64str) => { obj[file.name] = base64str; })
   .catch(error => console.error(error));
  
  i = i + 1;
  // console.log("i :", i);
 }

}

// ----------------------------------------------------
  
async function obtain_fileInfo_way1(file) {
 // WORKS!
 var base64_string = await new Promise((resolve) => {
  const reader = new FileReader();
  reader.onload = async function(e){ 
   resolve(e.target.result); // inside resolve is the value that the function returns
  };
  reader.readAsDataURL(file);
 });
  return base64_string;
}

// ----------------------------------------------------

async function Submit_to_cloudStorage() {

 console.log('obj: ', obj);

  var GCP_bucket_name = document.getElementById("GCP_bucket_name").value;
  // console.log("GCP_bucket_name :", GCP_bucket_name);
  
  var GCP_SA_KEY = btoa(document.getElementById("GCP_SA_KEY").value);
  
  // Loop over each key and save each file to storage
  var file_names = Object.keys(obj);
  // console.log("file_names: ", file_names)
  
  for (let i=0; i<file_names.length; i++) {
 
   var RepoAobj = {};
          RepoAobj.repoOwner = 'CodeSolutions2';
          RepoAobj.repoA_name = 'dragAndDrop_to_Storage';
          RepoAobj.repoB_name = 'dragAndDrop_to_Storage';  
          RepoAobj.n = 1;
         RepoAobj.foldername = 'src'; // foldername in RepoB
          RepoAobj.filename = `cb${i}.txt`; // filename to create in RepoB, in foldername
   
          RepoAobj.input_text = GCP_SA_KEY+"|"+GCP_bucket_name+"|"+file_names.at(i)+"|"+obj[file_names.at(i)];
   // console.log("RepoAobj.input_text: ", RepoAobj.input_text)
  
   await module.run_backend_process(RepoAobj);
  }
 
 
}

// ----------------------------------------------------

async function List_bucket_contents() {
 
 // List contents of bucket to the output 

 var url = `https://storage.googleapis.com/storage/v1/b/${document.getElementById("GCP_bucket_name").value}/o`
 
 await fetch_on_cloud_storage_return_contents_list(url)
   .then(async function(xmlDocument) {
    console.log('xmlDocument: ', xmlDocument);
    
    file_array = [];
    for (var i=0; i<xmlDocument.items.length; i++) {
     file_array.push(xmlDocument.items[i].name);
    }
    console.log('file_array: ', file_array);
    document.getElementById('notification').innerHTML = file_array; 
   })

}

async function fetch_on_cloud_storage_return_contents_list(url) {

 var settings = {
  type : 'GET',
  async: true,
  crossDomain: true,
  beforeSend: function(xhr) { xhr.withCredentials = true; },
  success: function(response) { console.log('Success'); },
  error: function(xhr, status, error) { console.log('Error:', error); }
 };
 
 return $.ajax(url, [,settings]).done(function(response) { return response; });
}

// -------------------------------------------------

 
</script>
</body>
</html>
