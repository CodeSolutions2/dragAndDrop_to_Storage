<!DOCTYPE html>
<html>
<head></head>
<body>
	
<button id="run_it" onclick="run_it()">run_it</button>
<button id="run_it2" onclick="run_it2()">run_it2</button>
<button id="shift_tf_xsTest_array" onclick="shift_tf_xsTest_array()">shift_tf_xsTest_array</button>

	
<!-- --------------------------------------------------- -->

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>


<script>


async function run_it() {
	
	var xs_test_3d_arr = [30.299999237060547, 31, 31.299999237060547, 26.299999237060547, 24.899999618530273, 24.299999237060547, 24, 23.100000381469727, 22.600000381469727, 22.399999618530273, 22];
	xs_test_3d_arr = tf.tensor(xs_test_3d_arr);
	
 	var batch_size = 19;
	
	xs_test_3d_arr = await create_correct_batchSize_for_xTest(xs_test_3d_arr, batch_size);
	console.log('xs_test_3d_arr: ', xs_test_3d_arr);

}


async function run_it2() {

	var x = [[[1], [2], [3], [4]], [[5], [6], [7], [8]]];

	shap = await shape(x);  
	console.log('Shape x: ', shap);

	// -----------------------------

	
	// -----------------------------

}

// -----------------------------------------------

async function create_correct_batchSize_for_xTest(xs_test_3d_arr, batch_size) {

	var xs_test_flat = await convert_tfarray_to_FlatnormalArray(xs_test_3d_arr);

	// ------------------------

	var xs_test_1d_arr = xs_test_flat;

	var xs_test_2d_arr = xs_test_1d_arr.map((val, ind) => { return [val]; });
	console.log('xs_test_2d_arr: ', xs_test_2d_arr); // [timesteps=11, num_of_features=1]

	shap = await shape(xs_test_2d_arr);  
	console.log('Shape xs_test_2d_arr: ', shap);

	// -----------------------------
	
	// Repeat xs_test batch_size times
	xs_test_3d_arr = [];
	for (var i=0; i<batch_size; i++) {
		xs_test_3d_arr.push(xs_test_2d_arr)
	}
	// console.log('xs_test_3d_arr: ', xs_test_3d_arr);  // [batch_size=19, timesteps=11, num_of_features=1]

	shap = await shape(xs_test_3d_arr);  
	console.log('Shape xs_test_3d_arr: ', shap);
	
	return tf.tensor(xs_test_3d_arr);
}
	


async function shift_tf_xsTest_array() {

	// Make an array that is shape [ 19, 11, 1 ]
	var dims = [ 19, 11, 1 ];
	var xs_test_3d_arr = await zeros(dims);

	// -----------------------------
	
	xs_test_3d_arr = tf.tensor3d(xs_test_3d_arr, [19,11,1]);
	console.log('xs_test_3d_arr: ', xs_test_3d_arr);

	// -----------------------------
	
	xs_test_3d_arr = xs_test_3d_arr.dataSync(); // Float32Array , [batch_size=1, timesteps=11, num_of_features=1]
	console.log('xs_test_3d_arr: ', xs_test_3d_arr);
	
	// -----------------------------
	
	// Convert the TypedArray into a normal array
	var normalArray = await Array.from(xs_test_3d_arr);
	console.log('normalArray: ', normalArray);

	// -----------------------------

	// Need a JavaScript reshape
	var normalArray1 = await reshape_arr(normalArray, dims)

	// -----------------------------
	
	// Ensure that the first batch is only used
	if (normalArray1.length > 1) {
		// only take the first batch
		normalArray1 = [normalArray1[0]];
	}

	// -----------------------------

	// Confirm that shape is [1, 11, 1]
	shap = await shape(normalArray1);  
	console.log('Shape normalArray1: ', shap);
	
	// -----------------------------

	// Flatten array
	var xs_test_flat = await flat_arr(normalArray1);   // [timesteps=11]
	console.log('xs_test_flat: ', xs_test_flat);
	
	// ------------------------
	
	var repeated_last_value = await Array.from({length: 1}, (val, ind) => { return xs_test_flat.at(xs_test_flat.length-1); });
	console.log('repeated_last_value: ', repeated_last_value);

	// -----------------------------
	
	var xs_test_1d_arr = xs_test_flat.slice(1, xs_test_flat.length).concat(repeated_last_value);
	console.log('xs_test_1d_arr: ', xs_test_1d_arr);
	
	// ------------------------
	
	var xs_test_2d_arr = xs_test_1d_arr.map((val, ind) => { return [val]; });
	xs_test_3d_arr = [xs_test_2d_arr];
	console.log('xs_test_3d_arr: ', xs_test_3d_arr);

	// -----------------------------
	
	// Confirm that shape is [1, 11, 1]
	shap = await shape(xs_test_3d_arr);  
	console.log('Shape xs_test_3d_arr: ', shap);

	// return tf.tensor(xs_test_3d_arr);
}






	


// -----------------------------------------------
// SUBFUNCTIONS
// -----------------------------------------------
async function recur_func(arr) {
	if (arr != undefined) {
		return [arr[0], arr.length];
	} else {
		return arr;
	}
}
	
async function shape(arr) {
	var out = await recur_func(arr);
	var shap = [out[1]];
	var c = 0; // typically work with 4D arrays or less
	while (out != undefined && c < 4) {
		out = await recur_func(out[0]);
		if (out != undefined) {
			shap.push(out[1]);
		}
		c = c + 1;
	}

	if (shap.length > 1) {
		shap = shap.slice(0, shap.length-1);
	}
	
	return shap;
}

// -----------------------------------------------

async function convert_tfarray_to_FlatnormalArray(xs_test_3d_arr) {

	xs_test_3d_arr = xs_test_3d_arr.dataSync(); // Float32Array , [batch_size=1, timesteps=11, num_of_features=1]
	console.log('xs_test_3d_arr: ', xs_test_3d_arr);

	// Convert the TypedArray into a normal array
	const normalArray = await Array.from(xs_test_3d_arr);
	console.log('normalArray: ', normalArray);
	
	var xs_test_flat = await flat_arr(normalArray);   // [timesteps=11]
	console.log('xs_test_flat: ', xs_test_flat);

	return xs_test_flat;
}
	
// -----------------------------------------------

function recur_flat(arr) {

	var out = [];
	for (var i=0; i<arr.length; i++) {
		if (Array.isArray(arr[i])) {
			out.push(recur_flat(arr[i].flat()));
		} else {
			out.push(arr[i]);
		}
	}
	return out.flat();
}
  
// -----------------------------------------------

async function flat_arr(arr) {

	var str = JSON.stringify(arr);
	const regex = /\b\d+\.\d+\b|\b\d+\b/g;
	var matches = str.match(regex);
	var floatArray = matches.map((val, ind) => { return Number(val); });
	
	return floatArray;
}

// -----------------------------------------------

async function zeros(dims) {

	// dims: [desired_0th_dim, desired_1st_dim, desired_2nd_dim]

	var out = [];
	
	if (dims.length == 1) {
		var desired_0th_dim = dims.at(0);
		
		out = Array.from({length: desired_0th_dim}, (val, ind) => { return 0; }); 

	} else if (dims.length == 2) {
		var desired_0th_dim = dims.at(0);
		var desired_1st_dim = dims.at(1);
		
		for (var i=0; i<desired_0th_dim; i++) {
			var arr = Array.from({length: desired_1st_dim}, (val, ind) => { return 0; }); 
			out.push(arr);
		}

	} else if (dims.length == 3) {
		var desired_0th_dim = dims.at(0);
		var desired_1st_dim = dims.at(1);
		var desired_2nd_dim = dims.at(2);
		
		for (var i=0; i<desired_0th_dim; i++) {
			temp = [];
			for (var j=0; j<desired_1st_dim; j++) {
				var arr = Array.from({length: desired_2nd_dim}, (val, ind) => { return 0; }); 
				temp.push(arr);
			}
			out.push(temp);
		}
		
	} else {
		console.log('Enter an array of length 1, 2, or 3. (ie: [desired_0th_dim, desired_1st_dim, desired_2nd_dim])')
	}
	
	return out;
}
	
// -----------------------------------------------

async function reshape_arr(arr, desired_dims) {

	// Flatten array
	var xs_test_flat = await flat_arr(arr);   // [timesteps=11]
	console.log('xs_test_flat: ', xs_test_flat);

	// -----------------------------
	
	var arr = await zeros(desired_dims);
	
	const shap = await shape(arr);  
	console.log('Shape arr: ', shap);

	if (shap.length == 2) {
		// Reshape 1D_flat to 2d
		var c = 0;
		for (var i=0; i<dims[0]; i++) {
			for (var j=0; j<dims[1]; j++) {
				arr[i][j][k] = xs_test_flat.at(c);
				c = c + 1;
			}
		}
	} else if (shap.length == 3) {
		// Reshape 1D_flat to 3d
		var c = 0;
		for (var i=0; i<dims[0]; i++) {
			for (var j=0; j<dims[1]; j++) {
				for (var k=0; k<dims[2]; k++) {
				       arr[i][j][k] = xs_test_flat.at(c);
					c = c + 1;
				}
			}
		}
	} else if (shap.length == 4) {
		// Reshape 1D_flat to 4d
		var c = 0;
		for (var i=0; i<dims[0]; i++) {
			for (var j=0; j<dims[1]; j++) {
				for (var k=0; k<dims[2]; k++) {
					for (var l=0; l<dims[3]; l++) {
					       arr[i][j][k][l] = xs_test_flat.at(c);
						c = c + 1;
					}
				}
			}
		}
	} else {
		arr = xs_test_flat;
	}
	// -----------------------------

	console.log('arr: ', arr);

	// -----------------------------
	
	return arr;
}
	
// -----------------------------------------------

// -----------------------------------------------


</script>
</body>
</html>
